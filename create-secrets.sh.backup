#!/bin/bash
# Stream Daemon - Secrets Management Setup Script
# This script helps create and configure secrets in Doppler, AWS Secrets Manager, or HashiCorp Vault

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Banner
echo -e "${CYAN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║        Stream Daemon - Secrets Setup Wizard              ║
║  Configure secrets for Doppler, AWS, or HashiCorp Vault  ║
╚═══════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"
echo ""

# Function to display section headers
section_header() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo ""
}

# Function to prompt for input with default value
prompt_with_default() {
    local prompt="$1"
    local default="$2"
    local var_name="$3"
    
    if [ -n "$default" ]; then
        read -p "$(echo -e ${GREEN}${prompt}${NC} [${YELLOW}${default}${NC}]: )" value
        eval $var_name="${value:-$default}"
    else
        read -p "$(echo -e ${GREEN}${prompt}${NC}: )" value
        eval $var_name="$value"
    fi
}

# Function to prompt for sensitive input (hidden)
prompt_secret() {
    local prompt="$1"
    local var_name="$2"
    
    read -s -p "$(echo -e ${GREEN}${prompt}${NC}: )" value
    echo ""
    eval $var_name="$value"
}

# Function to prompt yes/no
prompt_yes_no() {
    local prompt="$1"
    local default="${2:-N}"
    
    if [ "$default" = "Y" ]; then
        read -p "$(echo -e ${GREEN}${prompt}${NC} [${YELLOW}Y/n${NC}]): )" -n 1 -r response
    else
        read -p "$(echo -e ${GREEN}${prompt}${NC} [${YELLOW}y/N${NC}]): )" -n 1 -r response
    fi
    echo ""
    
    if [ "$default" = "Y" ]; then
        [[ ! $response =~ ^[Nn]$ ]]
    else
        [[ $response =~ ^[Yy]$ ]]
    fi
}

# Check if .env exists and offer to load it
if [ -f "$SCRIPT_DIR/.env" ]; then
    echo -e "${YELLOW}Found existing .env file${NC}"
    if prompt_yes_no "Load existing values from .env as defaults?" "Y"; then
        source "$SCRIPT_DIR/.env"
        LOAD_FROM_ENV=true
        echo -e "${GREEN}✓${NC} Loaded values from .env"
    else
        LOAD_FROM_ENV=false
    fi
else
    LOAD_FROM_ENV=false
fi

# Select secrets manager
section_header "Select Secrets Manager"
echo "Choose where you want to store your secrets:"
echo "  1) Doppler (Recommended - Modern secrets platform)"
echo "  2) AWS Secrets Manager (AWS cloud integration)"
echo "  3) HashiCorp Vault (Self-hosted, enterprise)"
echo "  4) Create .env file only (No secrets manager)"
echo ""

while true; do
    read -p "$(echo -e ${GREEN}Select option [1-4]${NC}: )" -n 1 -r SECRETS_MANAGER
    echo ""
    
    case $SECRETS_MANAGER in
        1) MANAGER="doppler"; break ;;
        2) MANAGER="aws"; break ;;
        3) MANAGER="vault"; break ;;
        4) MANAGER="env"; break ;;
        *) echo -e "${RED}Invalid option${NC}" ;;
    esac
done

echo ""
echo -e "${GREEN}✓${NC} Selected: ${CYAN}${MANAGER}${NC}"

# Collect streaming platform credentials
section_header "Streaming Platforms Configuration"

# Twitch
if prompt_yes_no "Configure Twitch?" "Y"; then
    TWITCH_ENABLE="True"
    prompt_with_default "Twitch Username" "${TWITCH_USERNAME}" "TWITCH_USERNAME"
    echo ""
    echo -e "${YELLOW}Twitch API credentials (get from: https://dev.twitch.tv/console)${NC}"
    prompt_with_default "Twitch Client ID" "${TWITCH_CLIENT_ID}" "TWITCH_CLIENT_ID"
    prompt_secret "Twitch Client Secret" "TWITCH_CLIENT_SECRET"
else
    TWITCH_ENABLE="False"
fi

# YouTube
if prompt_yes_no "Configure YouTube?" "Y"; then
    YOUTUBE_ENABLE="True"
    echo ""
    echo -e "${YELLOW}You can use either Channel ID or @Username${NC}"
    prompt_with_default "YouTube Channel ID (or leave empty)" "${YOUTUBE_CHANNEL_ID}" "YOUTUBE_CHANNEL_ID"
    if [ -z "$YOUTUBE_CHANNEL_ID" ]; then
        prompt_with_default "YouTube @Username" "${YOUTUBE_USERNAME}" "YOUTUBE_USERNAME"
    fi
    echo ""
    echo -e "${YELLOW}YouTube API Key (get from: https://console.cloud.google.com/apis/credentials)${NC}"
    prompt_secret "YouTube API Key" "YOUTUBE_API_KEY"
else
    YOUTUBE_ENABLE="False"
fi

# Kick
if prompt_yes_no "Configure Kick?" "N"; then
    KICK_ENABLE="True"
    prompt_with_default "Kick Username" "${KICK_USERNAME}" "KICK_USERNAME"
    
    if prompt_yes_no "Use Kick OAuth? (better rate limits)" "N"; then
        echo ""
        echo -e "${YELLOW}Kick OAuth requires 2FA enabled on your account${NC}"
        prompt_with_default "Kick Client ID" "${KICK_CLIENT_ID}" "KICK_CLIENT_ID"
        prompt_secret "Kick Client Secret" "KICK_CLIENT_SECRET"
    fi
else
    KICK_ENABLE="False"
fi

# Collect social platform credentials
section_header "Social Media Platforms Configuration"

# Mastodon
if prompt_yes_no "Configure Mastodon?" "Y"; then
    MASTODON_ENABLE_POSTING="True"
    prompt_with_default "Mastodon Instance URL" "${MASTODON_API_BASE_URL:-https://mastodon.social}" "MASTODON_API_BASE_URL"
    echo ""
    echo -e "${YELLOW}Get credentials from: ${MASTODON_API_BASE_URL}/settings/applications${NC}"
    prompt_with_default "Mastodon Client ID" "${MASTODON_CLIENT_ID}" "MASTODON_CLIENT_ID"
    prompt_secret "Mastodon Client Secret" "MASTODON_CLIENT_SECRET"
    prompt_secret "Mastodon Access Token" "MASTODON_ACCESS_TOKEN"
else
    MASTODON_ENABLE_POSTING="False"
fi

# Bluesky
if prompt_yes_no "Configure Bluesky?" "Y"; then
    BLUESKY_ENABLE_POSTING="True"
    prompt_with_default "Bluesky Handle" "${BLUESKY_HANDLE}" "BLUESKY_HANDLE"
    echo ""
    echo -e "${YELLOW}Create app password at: https://bsky.app/settings/app-passwords${NC}"
    prompt_secret "Bluesky App Password" "BLUESKY_APP_PASSWORD"
else
    BLUESKY_ENABLE_POSTING="False"
fi

# Discord
if prompt_yes_no "Configure Discord?" "Y"; then
    DISCORD_ENABLE_POSTING="True"
    echo ""
    echo -e "${YELLOW}Create webhook in Discord: Server Settings → Integrations → Webhooks${NC}"
    prompt_with_default "Discord Webhook URL" "${DISCORD_WEBHOOK_URL}" "DISCORD_WEBHOOK_URL"
    
    # Optional: Platform-specific webhooks
    if prompt_yes_no "Use different webhooks for each streaming platform?" "N"; then
        prompt_with_default "Twitch Discord Webhook" "${DISCORD_WEBHOOK_URL_TWITCH}" "DISCORD_WEBHOOK_URL_TWITCH"
        prompt_with_default "YouTube Discord Webhook" "${DISCORD_WEBHOOK_URL_YOUTUBE}" "DISCORD_WEBHOOK_URL_YOUTUBE"
        prompt_with_default "Kick Discord Webhook" "${DISCORD_WEBHOOK_URL_KICK}" "DISCORD_WEBHOOK_URL_KICK"
    fi
    
    # Optional: Role mentions
    if prompt_yes_no "Configure role mentions?" "N"; then
        prompt_with_default "Twitch Role Mention (e.g., @Twitch Viewers)" "${DISCORD_ROLE_MENTION_TWITCH}" "DISCORD_ROLE_MENTION_TWITCH"
        prompt_with_default "YouTube Role Mention" "${DISCORD_ROLE_MENTION_YOUTUBE}" "DISCORD_ROLE_MENTION_YOUTUBE"
        prompt_with_default "Kick Role Mention" "${DISCORD_ROLE_MENTION_KICK}" "DISCORD_ROLE_MENTION_KICK"
    fi
    
    # Optional: Live embed updates
    if prompt_yes_no "Enable live embed updates?" "Y"; then
        DISCORD_UPDATE_LIVE_MESSAGE="True"
        prompt_with_default "Update interval (seconds)" "${DISCORD_UPDATE_INTERVAL:-60}" "DISCORD_UPDATE_INTERVAL"
    fi
else
    DISCORD_ENABLE_POSTING="False"
fi

# Matrix
if prompt_yes_no "Configure Matrix?" "N"; then
    MATRIX_ENABLE_POSTING="True"
    prompt_with_default "Matrix Homeserver" "${MATRIX_HOMESERVER:-https://matrix.org}" "MATRIX_HOMESERVER"
    prompt_with_default "Matrix Room ID" "${MATRIX_ROOM_ID}" "MATRIX_ROOM_ID"
    
    if prompt_yes_no "Use access token? (recommended)" "Y"; then
        prompt_secret "Matrix Access Token" "MATRIX_ACCESS_TOKEN"
    else
        prompt_with_default "Matrix Username (e.g., @bot:matrix.org)" "${MATRIX_USERNAME}" "MATRIX_USERNAME"
        prompt_secret "Matrix Password" "MATRIX_PASSWORD"
    fi
else
    MATRIX_ENABLE_POSTING="False"
fi

# AI/LLM Configuration
section_header "AI/LLM Configuration (Optional)"

if prompt_yes_no "Enable AI-powered messages with Google Gemini?" "Y"; then
    LLM_ENABLE="True"
    LLM_PROVIDER="gemini"
    echo ""
    echo -e "${YELLOW}Get API key from: https://aistudio.google.com/app/apikey${NC}"
    prompt_secret "Gemini API Key" "LLM_GEMINI_API_KEY"
    prompt_with_default "Gemini Model" "${LLM_GEMINI_MODEL:-gemini-2.0-flash-exp}" "LLM_GEMINI_MODEL"
else
    LLM_ENABLE="False"
fi

# Settings
section_header "Stream Daemon Settings"

prompt_with_default "Check interval when offline (minutes)" "${SETTINGS_CHECK_INTERVAL:-5}" "SETTINGS_CHECK_INTERVAL"
prompt_with_default "Check interval when live (minutes)" "${SETTINGS_POST_INTERVAL:-60}" "SETTINGS_POST_INTERVAL"

# Message threading options
echo ""
echo "Multi-platform posting options:"
echo "  - separate: Individual posts per platform"
echo "  - thread: Reply chain"
echo "  - combined: Single post for all platforms"
prompt_with_default "Live announcement mode" "${MESSAGES_LIVE_THREADING_MODE:-combined}" "MESSAGES_LIVE_THREADING_MODE"
prompt_with_default "Stream end announcement mode" "${MESSAGES_END_THREADING_MODE:-single_when_all_end}" "MESSAGES_END_THREADING_MODE"

# Now create the secrets based on selected manager
section_header "Creating Secrets"

# Function to create Doppler secrets
create_doppler_secrets() {
    echo "Setting up Doppler secrets..."
    echo ""
    
    # Check if doppler CLI is installed
    if ! command -v doppler &> /dev/null; then
        echo -e "${YELLOW}Doppler CLI not found. Installing...${NC}"
        echo ""
        echo "Run these commands to install Doppler CLI:"
        echo "  curl -Ls https://cli.doppler.com/install.sh | sh"
        echo ""
        read -p "Press Enter after installing Doppler CLI..."
        
        if ! command -v doppler &> /dev/null; then
            echo -e "${RED}ERROR: Doppler CLI still not found${NC}"
            return 1
        fi
    fi
    
    echo -e "${GREEN}✓${NC} Doppler CLI installed"
    
    # Login check
    if ! doppler me &> /dev/null; then
        echo ""
        echo "Please login to Doppler:"
        doppler login
    fi
    
    echo -e "${GREEN}✓${NC} Logged in to Doppler"
    
    # Select or create project
    echo ""
    prompt_with_default "Doppler Project Name" "stream-daemon" "DOPPLER_PROJECT"
    prompt_with_default "Doppler Config (environment)" "dev" "DOPPLER_CONFIG"
    
    # Setup project
    if doppler projects get "$DOPPLER_PROJECT" &> /dev/null; then
        echo -e "${GREEN}✓${NC} Project '$DOPPLER_PROJECT' exists"
    else
        echo "Creating project '$DOPPLER_PROJECT'..."
        doppler projects create "$DOPPLER_PROJECT" --description "Stream Daemon secrets"
        echo -e "${GREEN}✓${NC} Project created"
    fi
    
    # Setup config
    if doppler configs get "$DOPPLER_CONFIG" --project "$DOPPLER_PROJECT" &> /dev/null; then
        echo -e "${GREEN}✓${NC} Config '$DOPPLER_CONFIG' exists"
    else
        echo "Creating config '$DOPPLER_CONFIG'..."
        doppler configs create "$DOPPLER_CONFIG" --project "$DOPPLER_PROJECT"
        echo -e "${GREEN}✓${NC} Config created"
    fi
    
    echo ""
    echo "Uploading secrets to Doppler..."
    
    # Create temporary env file
    TEMP_ENV=$(mktemp)
    
    # Streaming platforms
    [ "$TWITCH_ENABLE" = "True" ] && {
        echo "TWITCH_ENABLE=True" >> "$TEMP_ENV"
        echo "TWITCH_USERNAME=$TWITCH_USERNAME" >> "$TEMP_ENV"
        echo "TWITCH_CLIENT_ID=$TWITCH_CLIENT_ID" >> "$TEMP_ENV"
        echo "TWITCH_CLIENT_SECRET=$TWITCH_CLIENT_SECRET" >> "$TEMP_ENV"
    }
    
    [ "$YOUTUBE_ENABLE" = "True" ] && {
        echo "YOUTUBE_ENABLE=True" >> "$TEMP_ENV"
        [ -n "$YOUTUBE_CHANNEL_ID" ] && echo "YOUTUBE_CHANNEL_ID=$YOUTUBE_CHANNEL_ID" >> "$TEMP_ENV"
        [ -n "$YOUTUBE_USERNAME" ] && echo "YOUTUBE_USERNAME=$YOUTUBE_USERNAME" >> "$TEMP_ENV"
        echo "YOUTUBE_API_KEY=$YOUTUBE_API_KEY" >> "$TEMP_ENV"
    }
    
    [ "$KICK_ENABLE" = "True" ] && {
        echo "KICK_ENABLE=True" >> "$TEMP_ENV"
        echo "KICK_USERNAME=$KICK_USERNAME" >> "$TEMP_ENV"
        [ -n "$KICK_CLIENT_ID" ] && echo "KICK_CLIENT_ID=$KICK_CLIENT_ID" >> "$TEMP_ENV"
        [ -n "$KICK_CLIENT_SECRET" ] && echo "KICK_CLIENT_SECRET=$KICK_CLIENT_SECRET" >> "$TEMP_ENV"
    }
    
    # Social platforms
    [ "$MASTODON_ENABLE_POSTING" = "True" ] && {
        echo "MASTODON_ENABLE_POSTING=True" >> "$TEMP_ENV"
        echo "MASTODON_API_BASE_URL=$MASTODON_API_BASE_URL" >> "$TEMP_ENV"
        echo "MASTODON_CLIENT_ID=$MASTODON_CLIENT_ID" >> "$TEMP_ENV"
        echo "MASTODON_CLIENT_SECRET=$MASTODON_CLIENT_SECRET" >> "$TEMP_ENV"
        echo "MASTODON_ACCESS_TOKEN=$MASTODON_ACCESS_TOKEN" >> "$TEMP_ENV"
    }
    
    [ "$BLUESKY_ENABLE_POSTING" = "True" ] && {
        echo "BLUESKY_ENABLE_POSTING=True" >> "$TEMP_ENV"
        echo "BLUESKY_HANDLE=$BLUESKY_HANDLE" >> "$TEMP_ENV"
        echo "BLUESKY_APP_PASSWORD=$BLUESKY_APP_PASSWORD" >> "$TEMP_ENV"
    }
    
    [ "$DISCORD_ENABLE_POSTING" = "True" ] && {
        echo "DISCORD_ENABLE_POSTING=True" >> "$TEMP_ENV"
        echo "DISCORD_WEBHOOK_URL=$DISCORD_WEBHOOK_URL" >> "$TEMP_ENV"
        [ -n "$DISCORD_WEBHOOK_URL_TWITCH" ] && echo "DISCORD_WEBHOOK_URL_TWITCH=$DISCORD_WEBHOOK_URL_TWITCH" >> "$TEMP_ENV"
        [ -n "$DISCORD_WEBHOOK_URL_YOUTUBE" ] && echo "DISCORD_WEBHOOK_URL_YOUTUBE=$DISCORD_WEBHOOK_URL_YOUTUBE" >> "$TEMP_ENV"
        [ -n "$DISCORD_WEBHOOK_URL_KICK" ] && echo "DISCORD_WEBHOOK_URL_KICK=$DISCORD_WEBHOOK_URL_KICK" >> "$TEMP_ENV"
        [ -n "$DISCORD_ROLE_MENTION_TWITCH" ] && echo "DISCORD_ROLE_MENTION_TWITCH=$DISCORD_ROLE_MENTION_TWITCH" >> "$TEMP_ENV"
        [ -n "$DISCORD_ROLE_MENTION_YOUTUBE" ] && echo "DISCORD_ROLE_MENTION_YOUTUBE=$DISCORD_ROLE_MENTION_YOUTUBE" >> "$TEMP_ENV"
        [ -n "$DISCORD_ROLE_MENTION_KICK" ] && echo "DISCORD_ROLE_MENTION_KICK=$DISCORD_ROLE_MENTION_KICK" >> "$TEMP_ENV"
        [ "$DISCORD_UPDATE_LIVE_MESSAGE" = "True" ] && echo "DISCORD_UPDATE_LIVE_MESSAGE=True" >> "$TEMP_ENV"
        [ -n "$DISCORD_UPDATE_INTERVAL" ] && echo "DISCORD_UPDATE_INTERVAL=$DISCORD_UPDATE_INTERVAL" >> "$TEMP_ENV"
    }
    
    [ "$MATRIX_ENABLE_POSTING" = "True" ] && {
        echo "MATRIX_ENABLE_POSTING=True" >> "$TEMP_ENV"
        echo "MATRIX_HOMESERVER=$MATRIX_HOMESERVER" >> "$TEMP_ENV"
        echo "MATRIX_ROOM_ID=$MATRIX_ROOM_ID" >> "$TEMP_ENV"
        [ -n "$MATRIX_ACCESS_TOKEN" ] && echo "MATRIX_ACCESS_TOKEN=$MATRIX_ACCESS_TOKEN" >> "$TEMP_ENV"
        [ -n "$MATRIX_USERNAME" ] && echo "MATRIX_USERNAME=$MATRIX_USERNAME" >> "$TEMP_ENV"
        [ -n "$MATRIX_PASSWORD" ] && echo "MATRIX_PASSWORD=$MATRIX_PASSWORD" >> "$TEMP_ENV"
    }
    
    # LLM
    [ "$LLM_ENABLE" = "True" ] && {
        echo "LLM_ENABLE=True" >> "$TEMP_ENV"
        echo "LLM_PROVIDER=$LLM_PROVIDER" >> "$TEMP_ENV"
        echo "LLM_GEMINI_API_KEY=$LLM_GEMINI_API_KEY" >> "$TEMP_ENV"
        echo "LLM_GEMINI_MODEL=$LLM_GEMINI_MODEL" >> "$TEMP_ENV"
    }
    
    # Settings
    echo "SETTINGS_CHECK_INTERVAL=$SETTINGS_CHECK_INTERVAL" >> "$TEMP_ENV"
    echo "SETTINGS_POST_INTERVAL=$SETTINGS_POST_INTERVAL" >> "$TEMP_ENV"
    echo "MESSAGES_LIVE_THREADING_MODE=$MESSAGES_LIVE_THREADING_MODE" >> "$TEMP_ENV"
    echo "MESSAGES_END_THREADING_MODE=$MESSAGES_END_THREADING_MODE" >> "$TEMP_ENV"
    
    # Upload to Doppler
    doppler secrets upload "$TEMP_ENV" --project "$DOPPLER_PROJECT" --config "$DOPPLER_CONFIG"
    
    rm -f "$TEMP_ENV"
    
    echo ""
    echo -e "${GREEN}✓${NC} Secrets uploaded to Doppler!"
    echo ""
    echo "To use these secrets, set:"
    echo "  export DOPPLER_TOKEN=\$(doppler configs tokens create cli --project $DOPPLER_PROJECT --config $DOPPLER_CONFIG --plain)"
    echo ""
    echo "Or run Stream Daemon with:"
    echo "  doppler run --project $DOPPLER_PROJECT --config $DOPPLER_CONFIG -- python stream-daemon.py"
}

# Function to create AWS secrets
create_aws_secrets() {
    echo "Setting up AWS Secrets Manager..."
    echo ""
    
    # Check if AWS CLI is installed
    if ! command -v aws &> /dev/null; then
        echo -e "${RED}ERROR: AWS CLI not found${NC}"
        echo "Install with: pip install awscli"
        echo "Or see: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"
        return 1
    fi
    
    echo -e "${GREEN}✓${NC} AWS CLI installed"
    
    # Check AWS credentials
    if ! aws sts get-caller-identity &> /dev/null; then
        echo -e "${RED}ERROR: AWS credentials not configured${NC}"
        echo "Run: aws configure"
        return 1
    fi
    
    echo -e "${GREEN}✓${NC} AWS credentials configured"
    
    # Select region
    prompt_with_default "AWS Region" "${AWS_REGION:-us-east-1}" "AWS_REGION"
    
    # Create secrets
    SECRET_PREFIX="stream-daemon"
    
    echo ""
    echo "Creating secrets in AWS Secrets Manager..."
    
    # Streaming platforms
    if [ "$TWITCH_ENABLE" = "True" ]; then
        SECRET_VALUE=$(cat <<EOF
{
  "client_id": "$TWITCH_CLIENT_ID",
  "client_secret": "$TWITCH_CLIENT_SECRET",
  "username": "$TWITCH_USERNAME"
}
EOF
)
        aws secretsmanager create-secret \
            --name "${SECRET_PREFIX}/twitch" \
            --description "Twitch API credentials for Stream Daemon" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION" 2>/dev/null || \
        aws secretsmanager update-secret \
            --secret-id "${SECRET_PREFIX}/twitch" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION"
        
        echo -e "${GREEN}✓${NC} Twitch secrets created/updated"
    fi
    
    if [ "$YOUTUBE_ENABLE" = "True" ]; then
        SECRET_VALUE=$(cat <<EOF
{
  "api_key": "$YOUTUBE_API_KEY",
  "channel_id": "${YOUTUBE_CHANNEL_ID:-}",
  "username": "${YOUTUBE_USERNAME:-}"
}
EOF
)
        aws secretsmanager create-secret \
            --name "${SECRET_PREFIX}/youtube" \
            --description "YouTube API credentials for Stream Daemon" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION" 2>/dev/null || \
        aws secretsmanager update-secret \
            --secret-id "${SECRET_PREFIX}/youtube" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION"
        
        echo -e "${GREEN}✓${NC} YouTube secrets created/updated"
    fi
    
    if [ "$MASTODON_ENABLE_POSTING" = "True" ]; then
        SECRET_VALUE=$(cat <<EOF
{
  "api_base_url": "$MASTODON_API_BASE_URL",
  "client_id": "$MASTODON_CLIENT_ID",
  "client_secret": "$MASTODON_CLIENT_SECRET",
  "access_token": "$MASTODON_ACCESS_TOKEN"
}
EOF
)
        aws secretsmanager create-secret \
            --name "${SECRET_PREFIX}/mastodon" \
            --description "Mastodon API credentials for Stream Daemon" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION" 2>/dev/null || \
        aws secretsmanager update-secret \
            --secret-id "${SECRET_PREFIX}/mastodon" \
            --secret-string "$SECRET_VALUE" \
            --region "$AWS_REGION"
        
        echo -e "${GREEN}✓${NC} Mastodon secrets created/updated"
    fi
    
    # Add more platforms as needed...
    
    echo ""
    echo -e "${GREEN}✓${NC} Secrets created in AWS Secrets Manager!"
    echo ""
    echo "Set these environment variables to use AWS Secrets:"
    echo "  export SECRETS_SECRET_MANAGER=aws"
    echo "  export AWS_REGION=$AWS_REGION"
    echo "  export SECRETS_AWS_TWITCH_SECRET_NAME=${SECRET_PREFIX}/twitch"
    echo "  export SECRETS_AWS_YOUTUBE_SECRET_NAME=${SECRET_PREFIX}/youtube"
    echo "  export SECRETS_AWS_MASTODON_SECRET_NAME=${SECRET_PREFIX}/mastodon"
}

# Function to create Vault secrets
create_vault_secrets() {
    echo "Setting up HashiCorp Vault secrets..."
    echo ""
    
    # Check if vault CLI is installed
    if ! command -v vault &> /dev/null; then
        echo -e "${RED}ERROR: Vault CLI not found${NC}"
        echo "Install from: https://www.vaultproject.io/downloads"
        return 1
    fi
    
    echo -e "${GREEN}✓${NC} Vault CLI installed"
    
    # Get Vault config
    prompt_with_default "Vault URL" "${VAULT_ADDR:-http://127.0.0.1:8200}" "VAULT_ADDR"
    prompt_secret "Vault Token" "VAULT_TOKEN"
    
    export VAULT_ADDR
    export VAULT_TOKEN
    
    # Test connection
    if ! vault status &> /dev/null; then
        echo -e "${RED}ERROR: Cannot connect to Vault${NC}"
        return 1
    fi
    
    echo -e "${GREEN}✓${NC} Connected to Vault"
    
    # Create secrets
    SECRET_PATH="secret/stream-daemon"
    
    echo ""
    echo "Creating secrets in Vault..."
    
    if [ "$TWITCH_ENABLE" = "True" ]; then
        vault kv put "${SECRET_PATH}/twitch" \
            client_id="$TWITCH_CLIENT_ID" \
            client_secret="$TWITCH_CLIENT_SECRET" \
            username="$TWITCH_USERNAME"
        echo -e "${GREEN}✓${NC} Twitch secrets created"
    fi
    
    if [ "$YOUTUBE_ENABLE" = "True" ]; then
        vault kv put "${SECRET_PATH}/youtube" \
            api_key="$YOUTUBE_API_KEY" \
            channel_id="${YOUTUBE_CHANNEL_ID:-}" \
            username="${YOUTUBE_USERNAME:-}"
        echo -e "${GREEN}✓${NC} YouTube secrets created"
    fi
    
    if [ "$MASTODON_ENABLE_POSTING" = "True" ]; then
        vault kv put "${SECRET_PATH}/mastodon" \
            api_base_url="$MASTODON_API_BASE_URL" \
            client_id="$MASTODON_CLIENT_ID" \
            client_secret="$MASTODON_CLIENT_SECRET" \
            access_token="$MASTODON_ACCESS_TOKEN"
        echo -e "${GREEN}✓${NC} Mastodon secrets created"
    fi
    
    echo ""
    echo -e "${GREEN}✓${NC} Secrets created in Vault!"
    echo ""
    echo "Set these environment variables to use Vault:"
    echo "  export SECRETS_SECRET_MANAGER=vault"
    echo "  export SECRETS_VAULT_URL=$VAULT_ADDR"
    echo "  export SECRETS_VAULT_TOKEN=$VAULT_TOKEN"
    echo "  export SECRETS_VAULT_TWITCH_SECRET_PATH=${SECRET_PATH}/twitch"
    echo "  export SECRETS_VAULT_YOUTUBE_SECRET_PATH=${SECRET_PATH}/youtube"
    echo "  export SECRETS_VAULT_MASTODON_SECRET_PATH=${SECRET_PATH}/mastodon"
}

# Function to create .env file
create_env_file() {
    ENV_FILE="$SCRIPT_DIR/.env"
    
    echo "Creating .env file..."
    echo ""
    
    if [ -f "$ENV_FILE" ]; then
        if prompt_yes_no ".env already exists. Overwrite?" "N"; then
            rm "$ENV_FILE"
        else
            echo -e "${YELLOW}Keeping existing .env${NC}"
            return 0
        fi
    fi
    
    cat > "$ENV_FILE" << EOF
# Stream Daemon Configuration
# Generated by create-secrets.sh on $(date)

# ============================================
# Streaming Platforms
# ============================================

EOF
    
    # Twitch
    if [ "$TWITCH_ENABLE" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Twitch
TWITCH_ENABLE=True
TWITCH_USERNAME=$TWITCH_USERNAME
TWITCH_CLIENT_ID=$TWITCH_CLIENT_ID
TWITCH_CLIENT_SECRET=$TWITCH_CLIENT_SECRET

EOF
    fi
    
    # YouTube
    if [ "$YOUTUBE_ENABLE" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# YouTube
YOUTUBE_ENABLE=True
EOF
        [ -n "$YOUTUBE_CHANNEL_ID" ] && echo "YOUTUBE_CHANNEL_ID=$YOUTUBE_CHANNEL_ID" >> "$ENV_FILE"
        [ -n "$YOUTUBE_USERNAME" ] && echo "YOUTUBE_USERNAME=$YOUTUBE_USERNAME" >> "$ENV_FILE"
        cat >> "$ENV_FILE" << EOF
YOUTUBE_API_KEY=$YOUTUBE_API_KEY

EOF
    fi
    
    # Kick
    if [ "$KICK_ENABLE" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Kick
KICK_ENABLE=True
KICK_USERNAME=$KICK_USERNAME
EOF
        [ -n "$KICK_CLIENT_ID" ] && echo "KICK_CLIENT_ID=$KICK_CLIENT_ID" >> "$ENV_FILE"
        [ -n "$KICK_CLIENT_SECRET" ] && echo "KICK_CLIENT_SECRET=$KICK_CLIENT_SECRET" >> "$ENV_FILE"
        echo "" >> "$ENV_FILE"
    fi
    
    cat >> "$ENV_FILE" << EOF
# ============================================
# Social Media Platforms
# ============================================

EOF
    
    # Mastodon
    if [ "$MASTODON_ENABLE_POSTING" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Mastodon
MASTODON_ENABLE_POSTING=True
MASTODON_API_BASE_URL=$MASTODON_API_BASE_URL
MASTODON_CLIENT_ID=$MASTODON_CLIENT_ID
MASTODON_CLIENT_SECRET=$MASTODON_CLIENT_SECRET
MASTODON_ACCESS_TOKEN=$MASTODON_ACCESS_TOKEN

EOF
    fi
    
    # Bluesky
    if [ "$BLUESKY_ENABLE_POSTING" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Bluesky
BLUESKY_ENABLE_POSTING=True
BLUESKY_HANDLE=$BLUESKY_HANDLE
BLUESKY_APP_PASSWORD=$BLUESKY_APP_PASSWORD

EOF
    fi
    
    # Discord
    if [ "$DISCORD_ENABLE_POSTING" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Discord
DISCORD_ENABLE_POSTING=True
DISCORD_WEBHOOK_URL=$DISCORD_WEBHOOK_URL
EOF
        [ -n "$DISCORD_WEBHOOK_URL_TWITCH" ] && echo "DISCORD_WEBHOOK_URL_TWITCH=$DISCORD_WEBHOOK_URL_TWITCH" >> "$ENV_FILE"
        [ -n "$DISCORD_WEBHOOK_URL_YOUTUBE" ] && echo "DISCORD_WEBHOOK_URL_YOUTUBE=$DISCORD_WEBHOOK_URL_YOUTUBE" >> "$ENV_FILE"
        [ -n "$DISCORD_WEBHOOK_URL_KICK" ] && echo "DISCORD_WEBHOOK_URL_KICK=$DISCORD_WEBHOOK_URL_KICK" >> "$ENV_FILE"
        [ -n "$DISCORD_ROLE_MENTION_TWITCH" ] && echo "DISCORD_ROLE_MENTION_TWITCH=$DISCORD_ROLE_MENTION_TWITCH" >> "$ENV_FILE"
        [ -n "$DISCORD_ROLE_MENTION_YOUTUBE" ] && echo "DISCORD_ROLE_MENTION_YOUTUBE=$DISCORD_ROLE_MENTION_YOUTUBE" >> "$ENV_FILE"
        [ -n "$DISCORD_ROLE_MENTION_KICK" ] && echo "DISCORD_ROLE_MENTION_KICK=$DISCORD_ROLE_MENTION_KICK" >> "$ENV_FILE"
        [ "$DISCORD_UPDATE_LIVE_MESSAGE" = "True" ] && echo "DISCORD_UPDATE_LIVE_MESSAGE=True" >> "$ENV_FILE"
        [ -n "$DISCORD_UPDATE_INTERVAL" ] && echo "DISCORD_UPDATE_INTERVAL=$DISCORD_UPDATE_INTERVAL" >> "$ENV_FILE"
        echo "" >> "$ENV_FILE"
    fi
    
    # Matrix
    if [ "$MATRIX_ENABLE_POSTING" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# Matrix
MATRIX_ENABLE_POSTING=True
MATRIX_HOMESERVER=$MATRIX_HOMESERVER
MATRIX_ROOM_ID=$MATRIX_ROOM_ID
EOF
        [ -n "$MATRIX_ACCESS_TOKEN" ] && echo "MATRIX_ACCESS_TOKEN=$MATRIX_ACCESS_TOKEN" >> "$ENV_FILE"
        [ -n "$MATRIX_USERNAME" ] && echo "MATRIX_USERNAME=$MATRIX_USERNAME" >> "$ENV_FILE"
        [ -n "$MATRIX_PASSWORD" ] && echo "MATRIX_PASSWORD=$MATRIX_PASSWORD" >> "$ENV_FILE"
        echo "" >> "$ENV_FILE"
    fi
    
    # LLM
    if [ "$LLM_ENABLE" = "True" ]; then
        cat >> "$ENV_FILE" << EOF
# ============================================
# AI/LLM Configuration
# ============================================

LLM_ENABLE=True
LLM_PROVIDER=$LLM_PROVIDER
LLM_GEMINI_API_KEY=$LLM_GEMINI_API_KEY
LLM_GEMINI_MODEL=$LLM_GEMINI_MODEL

EOF
    fi
    
    # Settings
    cat >> "$ENV_FILE" << EOF
# ============================================
# Settings
# ============================================

SETTINGS_CHECK_INTERVAL=$SETTINGS_CHECK_INTERVAL
SETTINGS_POST_INTERVAL=$SETTINGS_POST_INTERVAL
MESSAGES_LIVE_THREADING_MODE=$MESSAGES_LIVE_THREADING_MODE
MESSAGES_END_THREADING_MODE=$MESSAGES_END_THREADING_MODE
EOF
    
    echo -e "${GREEN}✓${NC} Created .env file: $ENV_FILE"
    echo ""
    echo -e "${YELLOW}⚠ WARNING: .env contains sensitive credentials!${NC}"
    echo "  - Do NOT commit .env to git"
    echo "  - Keep it secure with: chmod 600 .env"
    
    chmod 600 "$ENV_FILE"
}

# Execute based on selected manager
case $MANAGER in
    doppler)
        create_doppler_secrets
        create_env_file  # Also create .env as backup
        ;;
    aws)
        create_aws_secrets
        create_env_file  # Also create .env as backup
        ;;
    vault)
        create_vault_secrets
        create_env_file  # Also create .env as backup
        ;;
    env)
        create_env_file
        ;;
esac

# Final summary
section_header "Setup Complete!"

echo "Next steps:"
echo ""
echo "1. ${GREEN}Test your configuration:${NC}"
echo "   python3 stream-daemon.py --test"
echo ""
echo "2. ${GREEN}Run Stream Daemon:${NC}"

case $MANAGER in
    doppler)
        echo "   doppler run -- python3 stream-daemon.py"
        ;;
    aws|vault)
        echo "   python3 stream-daemon.py"
        echo "   (Make sure SECRETS_SECRET_MANAGER is set)"
        ;;
    env)
        echo "   python3 stream-daemon.py"
        ;;
esac

echo ""
echo "3. ${GREEN}Install as systemd service:${NC}"
echo "   sudo ./install-systemd.sh"
echo ""

echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Happy streaming! 🎥${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo ""
